#!/bin/bash

export DISCLAIMER="# auto-generated by init.sh"

## Checking if Proxy is ok
echo -e "\n## Checking your proxy"
CODE=$(curl -sI pi.jorgeadolfo.com | head -1 | awk '{print $2}')
if [ "$CODE" = "470" ]; then
  echo -e "> proxy is not configured [$CODE]"
elif [[ "$CODE" = "502" ]]; then
  echo -e "> proxy is configured [OK]"
  echo "  Do you wish to continue with the setup? [ctrl-c to quit]"
  read -r
else
  echo "> proxy check was not ok [$CODE]"
fi


## Adding env variables and aliases to bashrc
echo -e "\n## Appending env variables and aliases to  ~/.bashrc"
echo "export http_proxy=http://webproxy.deutsche-boerse.de:8080 $DISCLAIMER" >> ~/.bashrc
echo "export https_proxy=http://webproxy.deutsche-boerse.de:8080 $DISCLAIMER" >> ~/.bashrc
echo "export no_proxy=*.deutsche-boerse.de $DISCLAIMER" >> ~/.bashrc
echo "alias l=ls\\ -l $DISCLAIMER" >> ~/.bash_aliases
echo "alias la=ls\\ -la $DISCLAIMER" >> ~/.bash_aliases
echo "alias cddotfiles=cd\\ ~/.dotfiles $DISCLAIMER" >> ~/.bash_aliases
echo "export EDITOR=vim $DISCLAIMER" >> ~/.bashrc
. ~/.bashrc


## Create a new ssh key
echo -e "\n## Creating a new ssh key"
ssh-keygen -t rsa


## Stop open github and add the new key
echo -e "\n## Open github and add your new ssh key\n"
echo -e "\n## press enter to copy your public key to your clipboard"
read -r
cat ~/.ssh/id_rsa.pub | xclip -i -selection clipboard
read -r
echo -e "\n## press enter to open firefox with github"
xdg-open https://github.com/settings/keys
echo -e "[press enter when you are done]"
read -r


## Configure the git/ssh proxy
echo -e "\n## Configuring the proxy on your ssh to clone git repos"
echo "host github.com $DISCLAIMER" >> ~/.ssh/config
echo "	hostname ssh.github.com $DISCLAIMER" >> ~/.ssh/config
echo "	user git $DISCLAIMER" >> ~/.ssh/config
echo "	port 443 $DISCLAIMER" >> ~/.ssh/config
echo "	proxycommand socat - PROXY:webproxy.deutsche-boerse.de:%h:%p,proxyport=8080 $DISCLAIMER" >> ~/.ssh/config


## Installing useful stuff
echo -e "\n## Installing useful stuff"
sudo apt install socat make -y


## Git cloning the dotfiles repo
echo -e "\n## Git cloning the dotfiles repo"
git clone --recurse-submodules git@github.com:rodelrod/dotfiles.git ~/.dotfiles


## Creating your bashrc in the repo
echo -e "\n## Creating an empty bashrc in the git repo [roles/common/stow]"
touch "$HOME/.dotfiles/roles/common/stow/bashrc/.bashrc.hosts.d/$(hostname).bashrc"


## Done
echo ""
