#!/bin/bash

export DISCLAIMER="# auto-generated by init.sh"
STEP=${1:-}
GREEN="\033[0;32m"
RED="\033[0;31m"
BLUE="\033[0;34m"
YELLOW="\033[0;33m"
NC="\033[0m"

read -r -p "Is this machine \`$(hostname)\` a DBG machine? [y/N] " response
response=${response,,} # tolower
IS_DBG=false
if [[ "$response" =~ ^(yes|y)$ ]]; then
  IS_DBG=
fi


## Checking if Proxy is ok
if [[ -z $IS_DBG && ( "$STEP" = "0" || -z "$STEP" ) ]]; then
  echo -e "\n## [0] Checking your proxy"
  CODE=$(curl -sI pi.jorgeadolfo.com | head -1 | awk '{print $2}')
  if [ "$CODE" = "470" ]; then
    echo -e "> proxy is not configured [$CODE]"
  elif [[ "$CODE" = "502" ]]; then
    echo -e "> proxy is configured [${GREEN}OK${NC}]"
    read -r -p "  Do you wish to continue with the setup? [Y/n] " response
    response=${response,,} # tolower
    if [[ "$response" =~ ^(no|n)$ ]]; then
      exit 0
    fi
  else
    echo -e "> proxy check was not ok [${RED}$CODE]${NC}"
  fi
fi


## Adding env variables and aliases to bashrc
if [[ -z $IS_DBG && ( "$STEP" = "1" || -z "$STEP" ) ]]; then
  GENERATED_LINES_FOUND=$(cat ~/.bashrc | grep init.sh | wc -l)
  if [[ "$GENERATED_LINES_FOUND" = "3" ]]; then
    echo -e "\n## [1] Appending env variables and aliases to  ~/.bashrc [${YELLOW}skiped${NC}]"
  else
    echo -e "\n## [1] Appending env variables and aliases to  ~/.bashrc"
    echo "export http_proxy=http://webproxy.deutsche-boerse.de:8080 $DISCLAIMER" >> ~/.bashrc
    echo "export https_proxy=http://webproxy.deutsche-boerse.de:8080 $DISCLAIMER" >> ~/.bashrc
    echo "export no_proxy=*.deutsche-boerse.de $DISCLAIMER" >> ~/.bashrc
  fi
  . ~/.bashrc
fi


## Create a new ssh key
if [[ "$STEP" = "2" ]] || [[ -z "$STEP" ]]; then
  if [[ -f ~/.ssh/id_rsa.pub ]]; then
    echo -e "\n## [2] Creating a new ssh key [${YELLOW}skiped${NC}]"
  else
    echo -e "\n## [2] Creating a new ssh key"
    ssh-keygen -t rsa
  fi
fi


## Stop open github and add the new key
if [[ "$STEP" = "3" ]] || [[ -z "$STEP" ]]; then
  read -r -p "  Do you wish to copy your pub key and open firefox? [Y/n] " response
  response=${response,,} # tolower
  if [[ "$response" =~ ^(yes|y)$ ]]; then
    echo -e "\n## [3] Open github and add your new ssh key\n"
    read -r -p "### press enter to copy your public key to your clipboard... "
    cat ~/.ssh/id_rsa.pub | xclip -i -selection clipboard
    read -r -p "### press enter to open firefox with github... "
    xdg-open https://github.com/settings/keys
    read -r -p "### press enter to continue... "
  else
    echo -e "\n## [3] Open github and add your new ssh key [${YELLOW}skiped${NC}]\n"
  fi
fi


## Configure the git/ssh proxy for GITHUB
if [[ -z $IS_DBG && ( "$STEP" = "4" || -z "$STEP" ) ]]; then
  CONFIGURE_SSH_CONFIG="YES"
  if [[ -f ~/.ssh/config ]]; then
    read -r -p "$( echo -e "\n  ~/.ssh/config ${GREEN}already exists${NC}\n  do you wish to append the proxy config? [y/N] ")" response
    response=${response,,} # tolower
    if [[ ! "$response" =~ ^(yes|y)$ ]]; then
      CONFIGURE_SSH_CONFIG=""
    fi
  fi
  if [[ "$CONFIGURE_SSH_CONFIG" = "YES" ]]; then
    echo -e "\n## [4] Configuring the proxy on your ssh to clone git repos"
    echo "host github.com" >> ~/.ssh/config
    echo "	hostname ssh.github.com" >> ~/.ssh/config
    echo "	user git" >> ~/.ssh/config
    echo "	port 443" >> ~/.ssh/config
    echo "	proxycommand socat - PROXY:webproxy.deutsche-boerse.de:%h:%p,proxyport=8080" >> ~/.ssh/config
    ## Configure the git/ssh proxy for GITLAB
    echo "host gitlab.com" >> ~/.ssh/config
    echo "	hostname altssh.gitlab.com" >> ~/.ssh/config
    echo "	user git" >> ~/.ssh/config
    echo "	port 443" >> ~/.ssh/config
    echo "	proxycommand socat - PROXY:webproxy.deutsche-boerse.de:%h:%p,proxyport=8080" >> ~/.ssh/config
  else
    echo -e "\n## [4] Configuring the proxy on your ssh to clone git repos [${YELLOW}skiped${NC}]"
  fi
fi


## Installing useful stuff
if [[ "$STEP" = "5" ]] || [[ -z "$STEP" ]]; then
  SOCAT_PATH=$(which socat)
  MAKE_PATH=$(which make)
  if [[ -z "$SOCAT_PATH" || -z "$MAKE_PATH" ]]; then
    echo -e "\n## [5] Installing socat and make"
    sudo apt install socat make -y
  else
    echo -e "\n## [5] Installing socat and make [${YELLOW}skiped${NC}]"
  fi
fi


## Git cloning the dotfiles repo
if [[ "$STEP" = "6" ]] || [[ -z "$STEP" ]]; then
  if [[ -d ~/.dotfiles ]]; then
    echo -e "\n## [6] Git cloning the dotfiles repo [${YELLOW}skiped${NC}]"
  else
    echo -e "\n## [6] Git cloning the dotfiles repo"
    git clone --recurse-submodules git@github.com:rodelrod/dotfiles.git ~/.dotfiles
  fi
fi


## Creating your bashrc in the repo
if [[ "$STEP" = "7" || -z "$STEP" ]]; then
  if [[ ! -f "$HOME/.dotfiles/roles/common/stow/bashrc/.bashrc.hosts.d/$(hostname).bashrc" ]]; then
    echo -e "\n## [7] Creating an empty bashrc in the git repo [roles/common/stow]"
    touch "$HOME/.dotfiles/roles/common/stow/bashrc/.bashrc.hosts.d/$(hostname).bashrc"
  else 
    echo -e "\n## [7] Creating an empty bashrc in the git repo [roles/common/stow] [${YELLOW}skiped${NC}]"
  fi
fi


## Done
echo ""
